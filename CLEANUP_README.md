# Очистка истёкших данных

## Описание

В проекте реализована автоматическая и ручная очистка истёкших промокодов и слов дня для поддержания чистоты базы данных.

## Автоматическая очистка

Очистка истёкших данных происходит автоматически при следующих действиях:

1. **Главная страница** (`/`) - при каждом запросе
2. **Мини-игра** (`/game`) - перед началом игры
3. **Проверка слова** (`/check_word`) - перед проверкой введённого слова
4. **Профиль пользователя** (`/profile`) - перед показом промокодов
5. **Корзина** (`/cart`) - перед показом корзины
6. **Применение промокода** (`/apply_promocode`) - перед применением
7. **Админ-панель товаров** (`/admin/products`) - перед показом товаров

## Ручная очистка

### Через админ-панель

1. Войдите в систему как администратор
2. Перейдите в админ-панель (`/admin`)
3. Найдите карточку "Очистка данных"
4. Нажмите кнопку "Очистить истёкшие данные"
5. Подтвердите действие

### Через командную строку

Запустите скрипт очистки:

```bash
python cleanup_script.py
```

## Планировщик задач (Cron)

Для автоматической очистки по расписанию добавьте в crontab:

```bash
# Очистка каждый час
0 * * * * cd /path/to/project && python cleanup_script.py

# Очистка каждый день в 3:00
0 3 * * * cd /path/to/project && python cleanup_script.py
```

## Функции очистки

### `cleanup_expired_promocodes()`
Удаляет все промокоды, у которых `valid_until < datetime.utcnow()`

### `cleanup_expired_words()`
Удаляет все слова дня, у которых `valid_until < datetime.utcnow()`

### `cleanup_expired_data()`
Вызывает обе функции очистки и возвращает количество удалённых записей

## Логирование

Все операции очистки логируются в консоль с временными метками:

```
[2024-01-15 10:30:00] Начинаем очистку истёкших данных...
[2024-01-15 10:30:01] Удалено 5 истёкших промокодов
[2024-01-15 10:30:01] Удалено 2 истёкших слов дня
[2024-01-15 10:30:01] Очистка завершена. Удалено промокодов: 5, слов дня: 2
```

## Безопасность

- Очистка доступна только администраторам
- Все операции выполняются в транзакциях с откатом при ошибках
- Подтверждение требуется для ручной очистки
- Автоматическая очистка не влияет на производительность

## Мониторинг

Для мониторинга состояния базы данных можно использовать SQL-запросы:

```sql
-- Количество истёкших промокодов
SELECT COUNT(*) FROM promocode WHERE valid_until < datetime('now');

-- Количество истёкших слов дня
SELECT COUNT(*) FROM word_of_the_day WHERE valid_until < datetime('now');

-- Промокоды, истекающие в ближайшие 24 часа
SELECT * FROM promocode WHERE valid_until BETWEEN datetime('now') AND datetime('now', '+1 day');
``` 